var $b0b865172f62a206b06d473890344e3b$exports = {};

var $b0b865172f62a206b06d473890344e3b$var$__rest = $b0b865172f62a206b06d473890344e3b$exports && $b0b865172f62a206b06d473890344e3b$exports.__rest || function (s, e) {
  var t = {};

  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];

  if (s != null && typeof Object.getOwnPropertySymbols === "function") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];
  }
  return t;
};

var $b0b865172f62a206b06d473890344e3b$var$__importStar = $b0b865172f62a206b06d473890344e3b$exports && $b0b865172f62a206b06d473890344e3b$exports.__importStar || function (mod) {
  if (mod && mod.__esModule) return mod;
  var result = {};
  if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
  result["default"] = mod;
  return result;
};

var $b0b865172f62a206b06d473890344e3b$var$__importDefault = $b0b865172f62a206b06d473890344e3b$exports && $b0b865172f62a206b06d473890344e3b$exports.__importDefault || function (mod) {
  return mod && mod.__esModule ? mod : {
    "default": mod
  };
};

Object.defineProperty($b0b865172f62a206b06d473890344e3b$exports, "__esModule", {
  value: true
});
const $b0b865172f62a206b06d473890344e3b$var$React = $b0b865172f62a206b06d473890344e3b$var$__importStar($parcel$require("b0b865172f62a206b06d473890344e3b", "react"));
const $b0b865172f62a206b06d473890344e3b$var$lodash_clonedeep_1 = $b0b865172f62a206b06d473890344e3b$var$__importDefault($parcel$require("b0b865172f62a206b06d473890344e3b", "lodash.clonedeep"));
const $b0b865172f62a206b06d473890344e3b$var$react_final_form_1 = $parcel$require("b0b865172f62a206b06d473890344e3b", "react-final-form"); // import * as jsonschema from 'jsonschema'

const $b0b865172f62a206b06d473890344e3b$var$ajv_1 = $b0b865172f62a206b06d473890344e3b$var$__importDefault($parcel$require("b0b865172f62a206b06d473890344e3b", "ajv"));
const $b0b865172f62a206b06d473890344e3b$var$pointer = $b0b865172f62a206b06d473890344e3b$var$__importStar($parcel$require("b0b865172f62a206b06d473890344e3b", "json-pointer"));
const $b0b865172f62a206b06d473890344e3b$var$mapSchemaToComponents_1 = $b0b865172f62a206b06d473890344e3b$var$__importDefault($parcel$require("b0b865172f62a206b06d473890344e3b", "./mapSchemaToComponents"));
const $b0b865172f62a206b06d473890344e3b$var$ajv = new $b0b865172f62a206b06d473890344e3b$var$ajv_1.default({
  jsonPointers: true,
  allErrors: true
});

var $b0b865172f62a206b06d473890344e3b$export$SchemaForm = ({
  schema,
  onChange = ({
    value
  }) => null,
  value = {},
  skipValidation = false
}) => {
  const [state, setState] = $b0b865172f62a206b06d473890344e3b$var$React.useState({
    values: {}
  });
  $b0b865172f62a206b06d473890344e3b$var$React.useEffect(() => {
    onChange(state);
  }, [state]);
  const validateSchema = $b0b865172f62a206b06d473890344e3b$var$React.useMemo(() => $b0b865172f62a206b06d473890344e3b$var$ajv.compile(schema), [schema]);

  if (Object.keys(schema).length === 0 && schema.constructor === Object) {
    return $b0b865172f62a206b06d473890344e3b$var$React.createElement($b0b865172f62a206b06d473890344e3b$var$React.Fragment, null);
  }

  const validate = data => {
    // console.log('validating')
    // console.log(JSON.stringify(ajv.errors, null, '\t'))
    const valid = validateSchema(data.root || {}); // console.log(JSON.stringify(ajv.errors, null, '\t'))

    if (!valid) {
      const error = validateSchema.errors.reduce((acc, _a) => {
        var {
          dataPath,
          message,
          keyword
        } = _a,
            rest = $b0b865172f62a206b06d473890344e3b$var$__rest(_a, ["dataPath", "message", "keyword"]);
        let parts = $b0b865172f62a206b06d473890344e3b$var$pointer.parse(dataPath);
        const params = rest.params;

        if (params && params.missingProperty) {
          if (params.missingProperty) {
            parts = [...parts, params.missingProperty];
          }
        }

        parts = ['root', ...parts]; // console.log(parts)

        acc = $b0b865172f62a206b06d473890344e3b$var$nestProperty(acc, parts, message); // console.log('accÂ ', acc)

        return Object.assign({}, acc);
      }, {}); // console.log('err', JSON.stringify(error, null, '\t'))

      return error;
    } else {
      return {
        root: {}
      };
    }
  }; // console.log(makeInitialValues(schema))


  return $b0b865172f62a206b06d473890344e3b$var$React.createElement($b0b865172f62a206b06d473890344e3b$var$React.Fragment, null, $b0b865172f62a206b06d473890344e3b$var$React.createElement($b0b865172f62a206b06d473890344e3b$var$react_final_form_1.Form, {
    initialValues: value || {
      root: $b0b865172f62a206b06d473890344e3b$var$makeInitialValues(schema)
    },
    // validateOnBlur={true}
    onSubmit: () => {},
    validate: skipValidation ? undefined : validate,
    render: _a => {
      var {
        handleSubmit,
        values
      } = _a,
          rest = $b0b865172f62a206b06d473890344e3b$var$__rest(_a, ["handleSubmit", "values"]);
      setState(state => state.values !== values['root'] ? Object.assign({
        values: values['root']
      }, rest) : state);
      return $b0b865172f62a206b06d473890344e3b$var$React.createElement($b0b865172f62a206b06d473890344e3b$var$React.Fragment, null, $b0b865172f62a206b06d473890344e3b$var$mapSchemaToComponents_1.default({
        schema,
        components: {},
        previousKey: 'root',
        skipValidation,
        formProps: Object.assign(Object.assign({}, rest), {
          values,
          handleSubmit
        })
      }));
    }
  }));
};

$b0b865172f62a206b06d473890344e3b$exports.SchemaForm = $b0b865172f62a206b06d473890344e3b$export$SchemaForm;
var $b0b865172f62a206b06d473890344e3b$export$default = $b0b865172f62a206b06d473890344e3b$exports.SchemaForm;
$b0b865172f62a206b06d473890344e3b$exports.default = $b0b865172f62a206b06d473890344e3b$export$default;

const $b0b865172f62a206b06d473890344e3b$var$nestProperty = (acc, parts, property) => {
  acc = $b0b865172f62a206b06d473890344e3b$var$lodash_clonedeep_1.default(acc);
  let obj = acc;

  for (let part of parts.slice(0, parts.length - 1)) {
    obj[part] = obj[part] || {};
    obj = obj[part];
  }

  obj[parts[parts.length - 1]] = property;
  return acc;
};

const $b0b865172f62a206b06d473890344e3b$var$defaultValue = _a => {
  var {
    type
  } = _a,
      rest = $b0b865172f62a206b06d473890344e3b$var$__rest(_a, ["type"]);

  switch (type) {
    // case 'string':
    //     return ''
    // case 'number':
    //     return 1
    case 'array':
      return [];

    case 'object':
      return $b0b865172f62a206b06d473890344e3b$var$makeInitialValues(rest);

    default:
      return undefined;
  }
};

const $b0b865172f62a206b06d473890344e3b$var$makeInitialValues = schema => {
  const initialValues = Object.entries(schema.properties || {}).reduce((acc, [k, v]) => {
    return Object.assign(Object.assign({}, acc), {
      [k]: $b0b865172f62a206b06d473890344e3b$var$defaultValue(v)
    });
  }, {});
  return initialValues;
}; //# sourceMappingURL=index.js.map